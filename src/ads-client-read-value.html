<script type="text/javascript">
  RED.nodes.registerType("ads-client-read-value", {
    paletteLabel: "ADS - Read Value",
    category: "TwinCAT ADS",
    icon: "font-awesome/fa-angle-double-right",
    color: "#3FADB5",
    inputs: 1,
    inputLabels: function () {
      return this.path === ""
        ? "Topic as path"
        : "Read trigger";
    },
    outputs: 1,
    outputLabels: "Data",
    defaults: {
      name: { value: "" },
      connection: { value: null, type: "ads-client-connection" },
      path: { value: "", required: false },
    },
    label: function () {
      if (this.connection === null)
        return `${this.name || `ADS - Read Value`} (*Not configured*)`;

      if (this.name) {
        return this.name;
      }

      return `ADS - Read Value (${
        this.path === "" ? `msg.topic` : `${this.path}`
      })`;
    },
    oneditprepare: function () {
      //Stuff that is done when properties panel is opened
    },
  });
</script>

<!-- Properties -->
<script type="text/html" data-template-name="ads-client-read-value">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name (optional)" />
  </div>

  <div class="form-row">
    <label for="node-input-connection"
      ><i class="fa fa-bookmark"></i> ADS connection</label
    >
    <input
      type="text"
      id="node-input-connection"
      placeholder="ADS Connection"
    />
  </div>

  <div class="form-row">
    <label for="node-input-path"
      ><i class="fa fa-tag"></i> Variable path</label
    >
    <input
      type="text"
      id="node-input-path"
      placeholder="Path"
    />
  </div>
  <div class="form-tips">
    <b>Tip:</b> Leave variable path empty to use <code>msg.topic</code> input
    instead.
  </div>

  <div class="form-row">
    <!-- Some margin after tip -->
  </div>
</script>

<!-- Help -->
<script type="text/html" data-help-name="ads-client-read-value">
  <p>
    Reads variable's value from the target system by a variable path (such as <code>GVL_Test.ExampleStruct</code>) and returns the value as object.
  </p>
  <p>
    <b>NOTE:</b> This requires that the target is a PLC runtime or has equivalent ADS protocol support.
  </p>

  <h3>Properties (settings)</h3>
    <dl class="message-properties">
      <dt>Name
        <span class="property-type">string</span>
      </dt>
      <dd> Optional node name</dd>
    </dl>

    <dl class="message-properties">
      <dt>ADS connection
        <span class="property-type">ads-client-connection</span>
      </dt>
      <dd> ADS client connection (target system) to use</dd>
    </dl>

    <dl class="message-properties">
      <dt>Path
        <span class="property-type">string</span>
      </dt>
      <dd> 
        Variable path in the PLC (such as <code>GVL_Test.ExampleStruct</code>)
      </dd>
    </dl>

  <h3>Inputs</h3>
    <dl class="message-properties">
      <dt>topic
        <span class="property-type">undefined | string</span>
      </dt>
      <dd> If provided and no variable path set in properties, this topic is used as path.</code></dd>
    </dl>

  <h3>Outputs</h3>
    <dl class="message-properties">
      <dt>payload <span class="property-type">any</span></dt>
      <dd>The value read</dd>
      <dt>rawValue <span class="property-type">object</span></dt>
      <dd>Raw value as Buffer</dd>
      <dt>dataType <span class="property-type">object</span></dt>
      <dd>Data type of the target symbol</dd>
      <dt>symbol <span class="property-type">object</span></dt>
      <dd>Target symbol</dd>
      <dt>... <span class="property-type">any</span></dt>
      <dd>All input <code>msg</code> properties are forwarded</dd>
    </dl>

  <h3>Details</h3>
    <p>
    If the variable path is not set in properties, the input <code>msg.topic</code> is used as variable path instead.
    </p>

  <h3>References</h3>
    <ul>
      <li><a href="https://github.com/jisotalo/ads-client/#reading-values" target="_blank" style="text-decoration: underline">
        ads-client readme
      </a></li>
      <li><a href="https://jisotalo.github.io/ads-client/Client.html#readValue" target="_blank" style="text-decoration: underline">
        ads-client readValue() documentation
      </a></li>
    </ul>
</script>
